<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Slider Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="slider-page">
<div class="container">

    <div class="widget current-day">
        <h3>Adjust Variables</h3>
        <div class="content-box">

            <!-- DATE -->
            <div class="variable">
                <label>Date</label>
                <input type="date" id="date">
            </div>

            <!-- RAIN MORNING -->
            <div class="variable">
                <div class="variable-top">
                    <label>Rain Morning</label>
                    <input type="number" id="rain_morning-num" value="0" step="0.5" class="variable-value">
                    <span>mm</span>
                </div>
                <div class="variable-slider">
                    <input type="range" id="rain_morning" min="0" max="50" step="0.5" value="0">
                </div>
            </div>

            <!-- RAIN AFTERNOON -->
            <div class="variable">
                <div class="variable-top">
                    <label>Rain Afternoon</label>
                    <input type="number" id="rain_afternoon-num" value="0" step="0.5" class="variable-value">
                    <span>mm</span>
                </div>
                <div class="variable-slider">
                    <input type="range" id="rain_afternoon" min="0" max="50" step="0.5" value="0">
                </div>
            </div>

            <!-- PRECIP MORNING -->
            <div class="variable">
                <div class="variable-top">
                    <label>Precip Morning</label>
                    <input type="number" id="precip_morning-num" value="0" step="0.5" class="variable-value">
                    <span>mm</span>
                </div>
                <div class="variable-slider">
                    <input type="range" id="precip_morning" min="0" max="50" step="0.5" value="0">
                </div>
            </div>

            <!-- PRECIP AFTERNOON -->
            <div class="variable">
                <div class="variable-top">
                    <label>Precip Afternoon</label>
                    <input type="number" id="precip_afternoon-num" value="0" step="0.5" class="variable-value">
                    <span>mm</span>
                </div>
                <div class="variable-slider">
                    <input type="range" id="precip_afternoon" min="0" max="50" step="0.5" value="0">
                </div>
            </div>

            <!-- TEMPERATURE -->
            <div class="variable">
                <div class="variable-top">
                    <label>Temperature</label>
                    <input type="number" id="temp-num" value="15" class="variable-value">
                    <span>°C</span>
                </div>
                <div class="variable-slider">
                    <input type="range" id="temp" min="-10" max="35" step="1" value="15">
                </div>
            </div>

        </div>
    </div>

    <div class="widget events">
        <h3>Prediction Comparison</h3>
        <div class="content-box">
            <canvas id="comparisonChart" height="220"></canvas>
        </div>
    </div>

    <div class="widget forecast">
        <div class="content-box forecast-box">
            <button class="confirm-button">Calculate</button>
            <p class="visitor-count" id="result">—</p>
            <p class="forecast-note">Adjusted forecast</p>
        </div>
    </div>

    <div class="widget manual-link">
        <div class="content-box link-box">
            <a href="{{ url_for('home') }}" class="manual-button">Dashboard</a>
        </div>
    </div>

</div>

<script>
function sync(id) {
    const range = document.getElementById(id);
    const num = document.getElementById(id + "-num");
    range.addEventListener("input", () => num.value = range.value);
    num.addEventListener("input", () => range.value = num.value);
}

["rain_morning", "rain_afternoon", "precip_morning", "precip_afternoon", "temp"].forEach(sync);

document.getElementById("date").value =
    new Date().toISOString().split("T")[0];

const chart = new Chart(
    document.getElementById("comparisonChart"),
    {
        type: "bar",
        data: {
            labels: ["Visitors"],
            datasets: [
                { label: "Normal prediction", data: [0] },
                { label: "Adjusted (slider)", data: [0] }
            ]
        }
    }
);

document.querySelector(".confirm-button").addEventListener("click", () => {
    const payload = {
        date: document.getElementById("date").value,
        temperature: document.getElementById("temp").value,

        rain_morning: document.getElementById("rain_morning").value,
        rain_afternoon: document.getElementById("rain_afternoon").value,

        precip_morning: document.getElementById("precip_morning").value,
        precip_afternoon: document.getElementById("precip_afternoon").value
    };

    console.log("Sending payload:", payload);

    fetch("/api/slider-predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("result").textContent =
            data.adjusted.toLocaleString() + " visitors";

        chart.data.datasets[0].data = [data.baseline];
        chart.data.datasets[1].data = [data.adjusted];
        chart.update();
    });
});
</script>

</body>
</html>
